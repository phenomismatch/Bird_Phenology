---
title: "Wing chord ~ age"
output:
  html_document:
    df_print: paged
author: Casey Youngflesh
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warnings = FALSE, message = FALSE)
```


#######NEEDS TO BE UPDATED

```{r}
# top-level dir -----------------------------------------------------------

dir <- '~/Google_Drive/R/'


# Load packages -----------------------------------------------------------

library(dplyr)
library(ggplot2)
library(kableExtra)

setwd(paste0(dir, 'Bird_Phenology/Data/Processed'))
maps_data <- readRDS('MAPS-age-filled.rds')
```


```{r}
#remove records that have weight 0 and wing chord 0
to.rm <- which(maps_data$weight == 0 | maps_data$wing_chord == 0 | 
                 is.na(maps_data$weight) | is.na(maps_data$fat_content) | is.na(maps_data$wing_chord))
maps_data_qc <- maps_data[-to.rm, ]

#only known-age adults
maps_adults_qc <- dplyr::filter(maps_data_qc, true_age > 0)

#find unique band ids
bid_cnt <- plyr::count(maps_adults_qc$band_id)

#individuals that have been captured more than 2 times
bid_c <- dplyr::filter(bid_cnt, freq > 2)
c_birds <- bid_c[,1]

#only band_ids of interest
maps_c <- dplyr::filter(maps_adults_qc, band_id %in% c_birds)

#band ids
nid <- unique(maps_c$band_id)


# calc mean and cv wing chord for each bird -----------------------------------------------------------

#For each individual, calculate mean and CV (sd/mean) for Age 1 wing chord and Age 2+ wing chord
ttd <- data.frame()
for (i in 1:length(nid))
{
  #i <- 2
  temp <- dplyr::filter(maps_c, band_id == nid[i])
  
  #only if have at least one year age > 1 and one year age = 1
  if (sum(temp$true_age > 1) > 0 & sum(temp$true_age == 1) > 0)
  {
    #age 1
    a1 <- mean(dplyr::filter(temp, true_age == 1)$wing_chord)
    a1_sd <- sd(dplyr::filter(temp, true_age == 1)$wing_chord)
    
    #age 2+
    a2p <- mean(dplyr::filter(temp, true_age > 1)$wing_chord)
    a2p_sd <- sd(dplyr::filter(temp, true_age > 1)$wing_chord)
    
    temp <- data.frame(sp = temp$sci_name[1], cn = temp$common_name[1],
                       band_id = nid[i], 
                       a1_wc = a1, a1_cv = a1_sd/a1, 
                       a2p_wc = a2p, a2p_cv = a2p_sd/a2p)
    ttd <- rbind(ttd, temp)
  }
}


#if sd within year 1 is greater than 3% of mean - exclude
#if sd year 2+ is greater than 5% of mean - exclude
to.rm.a1 <- which(ttd$a1_cv > 0.03)
to.rm.a2p <- which(ttd$a2p_cv > 0.05)
ctm <- c(to.rm.a1, to.rm.a2p)
ctm2 <- ctm[!(duplicated(ctm) | duplicated(ctm, fromLast = TRUE))]
#remove values
ttd2 <- ttd[-ctm2,]

#only species that have > 10 individuals
csp <- plyr::count(ttd2, 'sp')
nsp <- csp[which(csp$freq > 20), 1]

#filter relevant species
ttd3 <- dplyr::filter(ttd2, sp %in% nsp) 


# paired t-test for each species ------------------------------------------

#run paired t-test and calc mean wing chord and sd wing chord for each species
out <- data.frame()
for (i in 1:length(nsp))
{
  #i <- 1
  temp <- dplyr::filter(ttd3, sp == nsp[i])
  tfit <- t.test(temp$a1_wc, temp$a2p_wc, paired = TRUE)
  tt <- data.frame(sp = nsp[i],
                   cn = temp$cn[1],
                   a1_mn = round(mean(temp$a1_wc), 2),
                   a1_sd = round(sd(temp$a1_wc, na.rm = TRUE), 2),
                   a2p_mn = round(mean(temp$a2p_wc), 2),
                   a2p_sd = round(sd(temp$a2p_wc, na.rm = TRUE), 2),
                   est = round(tfit$estimate, 3), 
                   p = round(tfit$p.value, 4))
  out <- rbind(out, tt)
}
row.names(out) <- NULL

#Benjamini & Hochberg p-value correction
out$p_adj <-  round(p.adjust(out$p, method="BH"), 3)

out2 <- out[,c('sp', 'cn', 'est', 'p_adj')]
colnames(out2) <- c('scientific name', 'common name', 'difference', 'corrected p-value')
```


```{r}
sp_table <- knitr::kable(out2)
kableExtra::kable_styling(sp_table, bootstrap_options = "striped", full_width = F)
```

Table 1: Results from t-tests. Estimated differences in wing chord (in mm) between Age 1 (Second Year) and Age 2+ (Third Year +) birds and Benjamini & Hochberg adjusted p-values (multiple comparison correction). Negative values for differences in wing chord represent an increase in wing chord with age.

&nbsp;

```{r}
# plot results ------------------------------------------------------------

# #histograms of estimated differences and p-values
# hist(out$est)
# hist(out$p)

#boxplot
tplt <- reshape2::melt(ttd3[,c('sp', 'a1_wc', 'a2p_wc')], id = 'sp')
tplt$spvar <- interaction(tplt$sp, tplt$var)

ggplot(aes(y = value, x = sp, fill = variable), data = tplt) + 
  geom_boxplot() +
  theme_bw() +
  theme(legend.position="none",
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) + 
  coord_cartesian(ylim = c(38, 140)) +
  ylab('Wing chord (mm)') +
  xlab('Species')

#plots of all individuals used in final analysis
# nmc <- dplyr::filter(maps_c, band_id %in% ttd3$band_id)
# #wing chord
# ggplot(nmc, aes(true_age, wing_chord, col = band_id)) +
#   geom_line() +
#   theme_bw() +
#   theme(legend.position="none")
  
```

Figure 1: Boxplots for wing chord measurements for Age 1 (Second Year; RED) and Age 2+ (Third Year +; BLUE) birds for each species. Note that while the same individuals are shown in both groups, you can't properly visualize the paired differences between the two time period for each individual in this way. There are likely better ways to visualize these data.

