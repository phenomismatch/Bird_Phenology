===================
Pheno Mismatch notes
===================

trends_output notes
-------------------
2019-09-03 = beta as a function of lat - all cells
2019-09-04 = no beta as a function of lat (only cells that had pre IAR data)
2019-09-05 = no beta as a function of lat - pre IAR data


Notes from Oct 2018 meeting
===========================
Calculating mismatch -> caterpillar curve (abundance/biomass on y, time on x) and bird reproduction curve (abundance/biomass on y, time on x) -> overlay curves to calculate weighted index.
    Would expect positive relationship between productivity and curve area


*[DONE] Run single set of phi/theta
*[DONE] Run different phi/theta for each year
*[DONE] Run hierarchical phi/theta -> run time too long, params not estimated well
*[DONE] Run single year (2017) with just test set of cells - LARGE RHO
*[DONE] Fit all years with different phi/thetas and one phi/thetas
*[DONE] Filter cells by species ranges
*[DONE] Generalize creation of Stan script indices
*[DONE] Run V_olivaceus for all years/cells
*[DONE] Check maps
*[DONE] Setup script to run one species at a time
*[DONE] Determine which species to run (separate script?)
*[DONE] Test 4 on singularity - WORKS
*[DONE] Test 2 on singularity - WORKS
*[DONE] Test 7 on singularity - WORKS
*[DONE] Compare models with different sigma parameterizations
*[DONE] Check normality for 2
*[DONE] Query BR codes - extend to jday 300
*[DONE] Create provisional master IAR object
*[DONE] Full run 7 after query
*[DONE] Run 2 on cluster
*[DONE] Fit 4 with slope for lat
*[DONE] Run 3
*[DONE] Run 6 - query ebrid br codes (local)
*[DONE] Run 7
*[DONE] Run 4 tests - 3 species
*[DONE] *Polynomials (2nd to 6th) - RWBB
*[DONE] Test ebird query 1
*[DONE] Run 4 - BATCH
*[DONE] Test 2 (limited iter)
*[DONE] Transfer 2 test and check figs
*[DONE] Test 7 (GAM br)
*[DONE] Run 2 test (GAM arr)
*[DONE] Query new ebird
*[DONE] New age fill MAPS
*[DONE] Run wing chord ~ age analysis/make figs - send to Morgan
*[DONE] Wing chord ~ age
*[DONE] Run 2 (GAM)
*[DONE] Run 3 and 4



*Run 6 (query breeding) - need IAR species list from 3
*Run 7 (GAM)
*Run 8 (process 7)
*Run 9 (breeding IAR)


*Run MAPS brood patch model? Aggregate cells?
*Add correlation structure for gamma in IAR models - what was meant by this? Don't think this needs any correlation structure to be accounted for.



*Run arr/br model one species - cell random effect - is the effect of lat driving relationship between arr and br? (arrival predicts actual dates but not anomalies)
*Breeding IAR integrating other datasets
  -Query NW from DB
  -Model NW using 5th quantile? Model MAPS using logistic? Or proportion of yearlings hitting nets?
  -If no IAR, integrate other datasets into similar model


###
9
###
*Model change in br over lat/time and interaction
  -each species y ~ N(alpha_j + beta_j * year); beta_j = alpha2 + beta2 * lat
*Model change in arr over lat/time and interaction
  -run arrival model with all years of data, not just matching BS
  -each species y ~ N(alpha_j + beta_j * year); beta_j = alpha2 + beta2 * lat
  -could be fit jointly (i = cell, j = year, k = species:
    y[i,j,k] ~ N(alpha[j,k] + beta[j,k] * year[i,j,k])
    beta[j,k] = alpha2[k] + beta2[k] * lat[i,j,k]
    for each k:
      for each j:
        alpha[j,k] ~ N(mu_alpha[k], sigma_alpha[k])
      alpha2[k] ~ N(0, 10)
      beta2[k] ~ N(0, 10)
      mu_alpha[k] ~ N(mu_mu_alpha, sigma_mu_alpha)
      sigma_alpha ~ HN(mu_sigma_alpha, sigma_sigma_alpha)
    mu_mu_alpha ~ N(0, 10)
    sigma_mu_alpha ~ HN(0, 10)
    mu_sigma_alpha ~ N(0, 10)
    sigma_sigma_alpha ~ HN(0, 10)

*Check differences between y_true from br_arr and y_true from br_time
*Could get derived qty for y_true and x_true from above models - then model change in diff (controlling for arrival)
*Try to code using McElreath method - to account for correlations



*Generate qty: difference between ARR and BR -> birds compress the wait period later in the season (evidenced by the slope - breeding advances at a slower rate than arrival within a given season); has this interval changed over time (can model this is a few data-rich species - year effect on slope parameter)?
Diff_arr_br ~ alpha_j + beta1_j * year + beta2_j * arr #where j is species



*Aggregate MAPS cells and test logit models for MAPS breeding
*Run fat ~ lat/time

####
*lat differences in territory - leapfrogging migratory strategies
*Pete Mara - Kriten Ruegg
  -wood/sqainsons thrush
####

*For 7 - maybe run additional models with term that includes number of breeding obs recorded, just to make sure that number of people recording breeders has risen consistently with the number of eBird surveys - restrict 7 run by years? Missing IAR ARR could be informed by existing covariates at those positions




Demographics
============
*Spatially explicit integrated population model
    -look at how trends differ across species range
    -look at fluctuations in pop dynamics across species range
        -particularly as they pertain to range edges (recent paper about deforestation and range edges) -> larger fluctuations = less stable population
    -links to phenological dynamics
    -links to fat content/body mass from MAPS
    
    
    


*Look at MAPS BAND data for model - can look at age and phenology with these data as well

*Compare ebird breeding codes to nestwatch
  *model/plot
*Compare nestwatch to arrival/breeding codes to arrival
  *model/plot


To check which files (if any) contain a particular word
grep lookup_word * -lR


Cancel jobs
sq | awk '{print $1}' | tail -n +2 > tt.txt
while read p
do
  scancel "$p"
done <tt.txt



#GAM notes
https://stats.stackexchange.com/questions/352995/does-there-exist-theory-behind-how-many-knots-one-should-use-in-a-stan-gamm4-m?noredirect=1&lq=1
https://github.com/milkha/Splines_in_Stan/blob/master/splines_in_stan.pdf


#AFTER
*Run model nesting (Nestwatch) ~ arrival (IAR)
  -period between arrival and breeding may be plastic (as suggested for Black throated blues by Lany et al. 2016 - interval was shorter when greenup was earlier)
  -does the interval between arrival and nesting vary depending on 1) arrival/nesting time, 2) greenup time, or 3) the interval between arrival and greenup timing?
*Look at impact of green up on bird arrival (IAR)
  -are there other covariates that explain arrival well?
*Look at impact of green up on nesting date (Nestwatch, etc.)
  -are there other covariates that explain nesting well?



-Phenology may not be important for breeding success (predation may be important for breeding success)?
-Is breeding success important for population dynamics of these birds (for black-throated blues it is according to citation in Lany et al. 2016)?
-Does the interval between arrival and nesting impact population growth rates (e.g., are shorter intervals associated with lower pop growth rates [as we don't have breeding success info])?
-Integrate weight measurements from MAPS data when investigating mismatch and demographics (calculate deviation from each individual mean weight in a given year and see if there is a year effect across all individuals - that might indicate whether this is a 'good' or 'bad' year) - year effect should be done on a per site basis - should be restricted to a specific time window

